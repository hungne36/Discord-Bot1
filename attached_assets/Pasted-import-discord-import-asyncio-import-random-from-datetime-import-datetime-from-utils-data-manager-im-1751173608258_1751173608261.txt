import discord
import asyncio
import random
from datetime import datetime
from utils.data_manager import get_balance, update_balance, add_history
from utils.cooldown import can_play

# --- Game: TÃ i Xá»‰u ---
async def play_taixiu(interaction: discord.Interaction, amount: int, choice: str):
    uid = interaction.user.id
    ok, wait = can_play(uid)
    if not ok:
        return await interaction.response.send_message(f"â³ Vui lÃ²ng Ä‘á»£i {int(wait)} giÃ¢y ná»¯a!", ephemeral=True)

    bal = get_balance(uid)
    if amount < 1000 or amount > bal:
        return await interaction.response.send_message("âŒ Sá»‘ xu cÆ°á»£c khÃ´ng há»£p lá»‡!", ephemeral=True)

    # Hiá»‡u á»©ng há»“i há»™p
    await interaction.response.send_message("ğŸ² **Äang láº¯c sá»‘ pháº­n cá»§a báº¡n...**")
    await asyncio.sleep(1)
    await interaction.edit_original_response(content="ğŸ² **ChÃºc con nghiá»‡n 6 3 ra 1...** ğŸ¯")
    await asyncio.sleep(4)
    await interaction.edit_original_response(content="ğŸ² **QuÃªn ná»¯a, 1 4 ra 6...** â³")
    await asyncio.sleep(2)

    dice = [random.randint(1, 6) for _ in range(3)]
    tong = sum(dice)
    kq = "tai" if tong >= 11 else "xiu"
    win = (choice == kq)

    if win:
        profit = int(amount * 0.97)
        thaydoi = amount + profit
    else:
        thaydoi = -amount

    newb = update_balance(uid, thaydoi)
    add_history(uid, f"taixiu_{'tháº¯ng' if win else 'thua'}", thaydoi, newb)

    txt = (
        f"ğŸ² Káº¿t quáº£: {dice} â†’ {tong} â†’ **{kq.upper()}**\n"
        + ("ğŸ‰ HÃºp thÃ¬ xin tÃ½!\n" if win else "ğŸ’¸ ÄÆ°a Ä‘Ã­t Ä‘Ã¢y anh bÆ¡m thÃªm!\n")
        + f"ğŸ’° Thay Ä‘á»•i: {thaydoi:+,} xu | Sá»‘ dÆ° má»›i: {newb:,} xu"
    )
    await interaction.edit_original_response(content=txt)

# --- Game: Cháºµn Láº» ---
async def play_chanle(interaction: discord.Interaction, amount: int, choice: str):
    uid = interaction.user.id
    ok, wait = can_play(uid)
    if not ok:
        return await interaction.response.send_message(f"â³ Vui lÃ²ng Ä‘á»£i {int(wait)} giÃ¢y ná»¯a!", ephemeral=True)

    bal = get_balance(uid)
    if amount < 1000 or amount > bal:
        return await interaction.response.send_message("âŒ Sá»‘ xu cÆ°á»£c khÃ´ng há»£p lá»‡!", ephemeral=True)

    # Hiá»‡u á»©ng chá»
    await interaction.response.send_message("ğŸ•“ **Äáº¿m ngÆ°á»£c thÃ´i nÃ o...**")
    await asyncio.sleep(5)
    await interaction.edit_original_response(content="ğŸ•“ **Ra liá»n Ä‘á»«ng cÃ³ há»‘i...** â°")
    await asyncio.sleep(3)
    await interaction.edit_original_response(content="ğŸ•“ **Ra rá»“i nÃ¨...** â³")
    await asyncio.sleep(1)

    giay = datetime.utcnow().second
    so1, so2 = divmod(giay, 10)
    tong = so1 + so2
    kq = "chan" if tong % 2 == 0 else "le"
    win = (choice == kq)

    if win:
        profit = int(amount * 0.95)
        thaydoi = amount + profit
    else:
        thaydoi = -amount

    newb = update_balance(uid, thaydoi)
    add_history(uid, f"chanle_{'tháº¯ng' if win else 'thua'}", thaydoi, newb)

    msg = (
        f"ğŸ•“ Káº¿t quáº£: {giay} â†’ {so1}+{so2}={tong} â†’ **{kq.upper()}**\n"
        + ("ğŸ‰ Ã”i báº¡n tháº¯ng gá»›m!\n" if win else "ğŸ’¸ Eo báº¡n Ä‘áº§n vÃ£i lá»£n!\n")
        + f"ğŸ’° Thay Ä‘á»•i: {thaydoi:+,} xu | Sá»‘ dÆ° má»›i: {newb:,} xu"
    )
    await interaction.edit_original_response(content=msg)